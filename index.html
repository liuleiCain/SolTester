<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>合约调试</title>
    <link rel="stylesheet" href="/css/layui.css">
    <script src="/js/jquery.min.js"></script>
</head>
<body>

<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>合约调试</legend>
</fieldset>

<div class="layui-col-xs6">
    <blockquote class="layui-elem-quote">
        连接Metamask
        &nbsp;
        <button type="button" class="layui-btn" onclick="connectWeb3(this)">连接钱包</button>
    </blockquote>

    <form class="layui-form">
        <div class="layui-col-sm-offset1">
            <div class="layui-form-item">
                <label class="layui-form-label">账户地址：</label>
                <div class="layui-input-block">
                    <input type="text" name="title" class="layui-input" id="account" disabled>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">区块链：</label>
                <div class="layui-input-block">
                    <input type="text" name="title" class="layui-input" id="chain" disabled>
                </div>
            </div>
        </div>


        <blockquote class="layui-elem-quote">
            合约初始化
        </blockquote>

        <div class="layui-col-sm-offset1">
            <div class="layui-form-item">
                <label class="layui-form-label">合约地址：</label>
                <div class="layui-input-block">
                    <input type="text" name="title" placeholder="请输入合约地址" class="layui-input" id="address" value="0x2bC04DfDF628068e68b1b397122BD01EFDcB7e8b">
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">合约Abi：</label>
                <div class="layui-input-block">
                    <textarea placeholder="请输入合约Abi数组" class="layui-textarea" id="abi" onchange="updateAbi(this)"></textarea>
                </div>
            </div>


            <div class="layui-form-item layui-col-xs6">
                <label class="layui-form-label">合约方法：</label>
                <div class="layui-input-block">
                    <select name="interest" lay-filter="abiMethod" id="abiMethod">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item" id="abiInput">

            </div>
            <br>
            <button type="button" class="layui-btn layui-btn-normal" onclick="sendTx(this)">发送Send</button>
        </div>
    </form>
</div>
<div class="layui-col-xs6">
    <div class="layui-bg-gray" style="padding: 30px;">
        <div class="layui-row layui-col-space15">
            <div class="layui-card">
                <div class="layui-card-header">请求结果</div>
                <div class="layui-card-body" id="content" style="height: 500px;">

                </div>
            </div>
        </div>
    </div>
</div>

<script src="/layui.js"></script>
<script>
    let form, layer;
    layui.use(['form', 'layer'], function () {
        form = layui.form;
        layer = layui.layer;
        form.on('select(abiMethod)', function (data) {
            document.getElementById("abiInput").innerHTML = ""
            let abi = JSON.parse(document.getElementById("abi").value)
            let abiMethod = abi[data.value]
            let html = "";
            for (let v of abiMethod.inputs) {
                html += '<div class="layui-form-item">\n' +
                    '    <label class="layui-form-label">参数：</label>' +
                    '    <div class="layui-input-block">\n' +
                    '      <input type="text" name="params" id="params" placeholder="' + v.name + '" autocomplete="off" class="layui-input">\n' +
                    '    </div>\n' +
                    '  </div>'
            }
            document.getElementById("abiInput").innerHTML = html
            form.render()
        });
    });

    function connectWeb3(obj) {
        if (typeof window.ethereum == 'undefined') {
            layer.alert('MetaMask not installed!');
            return false;
        }
        if (window.ethereum) {
            try {
                // 请求用户授权
                window.ethereum.enable();
            } catch (error) {
                // 用户不授权时
                console.error("User denied account access")
            }
        }
        web3js = new Web3(window.ethereum);//web3js就是你需要的web3实例
        web3js.eth.getAccounts(function (error, result) {
            if (!error) {
                obj.innerHTML = "已连接"
                obj.classList.add("layui-btn-disabled")
                document.getElementById("account").value = result[0]
                document.getElementById("chain").value = window.ethereum.networkVersion
            }
        });
    }

    function updateAbi(obj) {
        if (!isJSON(obj.value)) {
            layer.msg("Abi内容错误")
            obj.value = ""
            document.getElementById("abiMethod").options.length = 0;
            document.getElementById("abiMethod").options.add(new Option("", ""));
        } else {
            let abi = JSON.parse(obj.value)
            for (let i in abi) {
                if (abi[i].type == 'function') {
                    switch (abi[i].stateMutability) {
                        case "view":
                            document.getElementById("abiMethod").options.add(new Option(abi[i].name + '(read)', i));
                            break;
                        default:
                            document.getElementById("abiMethod").options.add(new Option(abi[i].name + '(write)', i));
                    }

                }
            }
        }
        form.render()
    }

    async function sendTx(obj) {
        let contractAddress = document.getElementById("address").value
        if (typeof window.ethereum == 'undefined') {
            layer.alert('MetaMask is not installed!');
            return false;
        }
        if (!window.ethereum.isConnected()) {
            layer.alert('MetaMask is not connected!');
            return false;
        }
        if (contractAddress === "") {
            layer.alert('请输入合约地址');
            return false;
        }
        if (!isJSON(document.getElementById("abi").value)) {
            layer.alert('Abi内容错误');
            return false;
        }
        let abiMethod = document.getElementById("abiMethod").value;
        if (abiMethod === "") {
            layer.alert('选择执行的合约方法');
            return false;
        }
        let abi = JSON.parse(document.getElementById("abi").value)
        let abiSingle = abi[abiMethod]
        console.log("abiMethod", abiSingle)
        let contract = await web3.eth.contract(abi).at(contractAddress)

        //获取参数
        let args = []
        $("#abiInput").find("input").each(function (i) {
            args.push($(this).val())
        })
        console.log(args)
        contract[abiSingle.name](args, function (err, res) {
            if (err) {
                document.getElementById("content").innerHTML = err.message
            } else {
                document.getElementById("content").innerHTML = JSON.stringify(res);
            }
        })
    }

    function isJSON(str) {
        if (typeof str == 'string') {
            try {
                var obj = JSON.parse(str);
                if (typeof obj == 'object' && obj) {
                    return true;
                } else {
                    return false;
                }

            } catch (e) {
                console.log('error：' + str + '!!!' + e);
                return false;
            }
        }
    }

    window.ethereum.on('accountsChanged', (accounts) => {
        if (window.ethereum.isConnected()) {
            document.getElementById("account").value = accounts[0]
        }
    });

    window.ethereum.on('chainChanged', (chainId) => {
        if (window.ethereum.isConnected()) {
            document.getElementById("chain").value = window.ethereum.networkVersion
        }
    });
</script>
</body>
</html>
